<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>Idempotency - Light 4J - A fast, lightweight Java microservices framework</title>
    <meta name="generator" content="Hugo 0.20.6" />

    
    <meta name="description" content="Light 4J Docs">
    
    <link rel="canonical" href="https://networknt.github.io/light-4j/design/idempotency/">
    
    <meta name="author" content="Steve Hu">
    

    <meta property="og:url" content="https://networknt.github.io/light-4j/design/idempotency/">
    <meta property="og:title" content="Light 4J - A fast, lightweight Java microservices framework">
    <meta property="og:image" content="https://networknt.github.io/light-4j/images/logo.png">
    <meta name="apple-mobile-web-app-title" content="Light 4J - A fast, lightweight Java microservices framework">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="https://networknt.github.io/light-4j/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="https://networknt.github.io/light-4j/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('https://networknt.github.io/light-4j/fonts/icon.eot');
        src: url('https://networknt.github.io/light-4j/fonts/icon.eot')
               format('embedded-opentype'),
             url('https://networknt.github.io/light-4j/fonts/icon.woff')
               format('woff'),
             url('https://networknt.github.io/light-4j/fonts/icon.ttf')
               format('truetype'),
             url('https://networknt.github.io/light-4j/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="https://networknt.github.io/light-4j/stylesheets/application.css">
    <link rel="stylesheet" href="https://networknt.github.io/light-4j/stylesheets/temporary.css">
    <link rel="stylesheet" href="https://networknt.github.io/light-4j/stylesheets/palettes.css">
    <link rel="stylesheet" href="https://networknt.github.io/light-4j/stylesheets/highlight/highlight.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu&#43;Mono">
    <style>
      body, input {
        font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="https://networknt.github.io/light-4j/javascripts/modernizr.js"></script>

    

  </head>
  <body class="palette-primary-red palette-accent-teal">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Idempotency
      </div>
    </div>

    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/stevehu" title="@stevehu on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/networknt/light-4j" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="https://networknt.github.io/light-4j/images/logo.png">
        </div>
      
      <div class="name">
        <strong>Light 4J - A fast, lightweight Java microservices framework <span class="version">1.4.6</span></strong>
        
          <br>
          networknt/light-4j
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="https://github.com/networknt/light-4j/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/networknt/light-4j/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Getting started" href="https://networknt.github.io/light-4j/getting-started/">
	
	Getting started
</a>



  
</li>



<li>
  
    



<a  title="Architecture" href="https://networknt.github.io/light-4j/architecture/">
	
	Architecture
</a>



  
</li>



<li>
  
    



<a  title="Design" href="https://networknt.github.io/light-4j/design/">
	
	Design
</a>



  
</li>



<li>
  
    



<a  title="Middleware" href="https://networknt.github.io/light-4j/middleware/">
	
	Middleware
</a>



  
</li>



<li>
  
    



<a  title="Other Components" href="https://networknt.github.io/light-4j/other/">
	
	Other Components
</a>



  
</li>



<li>
  
    



<a  title="DevOps" href="https://networknt.github.io/light-4j/devops/">
	
	DevOps
</a>



  
</li>



<li>
  
    



<a  title="Benchmarks" href="https://networknt.github.io/light-4j/benchmarks/">
	
	Benchmarks
</a>



  
</li>



<li>
  
    



<a  title="Tutorials" href="https://networknt.github.io/light-4j/tutorials/">
	
	Tutorials
</a>



  
</li>



<li>
  
    



<a  title="Examples" href="https://networknt.github.io/light-4j/example/">
	
	Examples
</a>



  
</li>



<li>
  
    



<a  title="Tools" href="https://networknt.github.io/light-4j/tools/">
	
	Tools
</a>



  
</li>



<li>
  
    



<a  title="Issues &amp; Help" href="https://github.com/networknt/light-4j/issues">
	
	Issues &amp; Help
</a>



  
</li>



<li>
  
    



<a  title="Roadmap" href="https://networknt.github.io/light-4j/roadmap/">
	
	Roadmap
</a>



  
</li>



<li>
  
    



<a  title="FAQ" href="https://networknt.github.io/light-4j/faq/">
	
	FAQ
</a>



  
</li>



<li>
  
    



<a  title="License" href="https://www.apache.org/licenses/LICENSE-2.0">
	
	License
</a>



  
</li>



<li>
  
    



<a  title="Introduction" href="https://networknt.github.io/light-4j/index.html">
	
	Introduction
</a>



  
</li>


        </ul>
        

        
        <hr>
        <span class="section">The author</span>
        
        <ul>
          

          
          <li>
            <a href="https://github.com/stevehu" target="_blank" title="@stevehu on GitHub">
              @stevehu on GitHub
            </a>
          </li>
          

          
          <li>
            <a href="mailto:stevehu@gmail.com" title="Email of stevehu@gmail.com">
              Contact via email
            </a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>Idempotency </h1>

			

<h1 id="networks-are-unreliable">Networks are unreliable.</h1>

<p>The networks connecting our clients and servers are, on average, more reliable than
consumer-level last miles like cellular or home ISPs, but given enough information
moving across the wire, they’re still going to fail given enough time. Outages,
routing problems, and other intermittent failures may be statistically unusual on
the whole, but still bound to be happening all the time at some ambient background rate.</p>

<p>While in microservices architecture, the number of network connections grow
exponentially and the risk of network issues will be much higher than monolithic
applications.</p>

<p>To overcome this sort of inherently unreliable environment, it’s important to design
APIs and clients that will be robust in the event of failure, and will predictably
bring a complex integration to a consistent state despite failures. Remember that a
service might be a client when calling another service.</p>

<h1 id="planning-for-failure">Planning for failure</h1>

<p>Consider a call between any two nodes. There are a variety of failures that can occur:</p>

<ul>
<li><p>The initial connection could fail as the client tries to connect to a server.</p></li>

<li><p>The call could fail midway while the server is fulfilling the operation, leaving
the work in limbo.</p></li>

<li><p>The call could succeed, but the connection break before the server can tell its
client about it.</p></li>
</ul>

<p>Any one of these leaves the client that made the request in an uncertain situation.
In some cases, the failure is definitive enough that the client knows with good certainty
that it’s safe to simply retry it. For example, a total failure to even establish a
connection to the server. In many others though, the success of the operation is ambiguous
from the perspective of the client, and it doesn’t know whether retrying the operation is
safe. A connection terminating midway through message exchange is an example of this case.</p>

<p>This problem is a classic staple of distributed systems, and the definition is broad when
talking about a “distributed system” in this sense: as few as two computers connecting
via a network that are passing each other messages.</p>

<p>With microservices are getting popular, the partial failure is more complicated as it can
happen deep in the chain of services. It is not a simple retry from any client and the retry
has to be initialized from the original client. This requires all the services in the chain
must be idempotent.</p>

<h1 id="use-of-idempotency">Use of idempotency</h1>

<p>The easiest way to address inconsistencies in distributed state caused by failures is to
implement server endpoints so that they’re idempotent, which means that they can be called
any number of times while guaranteeing that side effects only occur once.</p>

<p>When a client sees any kind of error, it can ensure the convergence of its own state with
the server’s by retrying, and can continue to retry until it verifiably succeeds. This
fully addresses the problem of an ambiguous failure because the client knows that it can
safely handle any failure using one simple technique.</p>

<p>As an example, consider the API call for a hypothetical DNS provider that enables us to add
subdomains via an HTTP request:</p>

<p>All the information needed to create a record is included in the call, and it’s perfectly
safe for a client to invoke it any number of times. If the server receives a call that it
realizes is a duplicate because the domain already exists, it simply ignores the request and
responds with a successful status code.</p>

<p>According to HTTP semantics, the PUT and DELETE verbs are idempotent, and the PUT verb in
particular signifies that a target resource should be created or replaced entirely with the
contents of a request’s payload (in modern RESTful service, a partial modification would be
represented by a PATCH).</p>

<p>We have used request/response communication style as an example; however, messaging based
microservices should follow the same approach in case duplicate messages are delivery in the
pipeline.</p>

<h1 id="guarantee-exactly-once">Guarantee exactly once</h1>

<p>While the inherently idempotent HTTP semantics around PUT and DELETE are a good fit for many
API calls, what if we have an operation that needs to be invoked exactly once and no more?
An example might be if we were designing an API endpoint to charge a customer money; accidentally
calling it twice would lead to the customer being double-charged, which is very bad.</p>

<p>This is where idempotency keys come into play. When performing a request, a client generates a
unique ID to identify just that operation and sends it up to the server along with the normal
payload. The server receives the ID and correlates it with the state of the request on its end.
If the client notices a failure, it retries the request with the same ID, and from there it’s
up to the server to figure out what to do with it.</p>

<p>If we consider our sample network failure cases from above:</p>

<ul>
<li><p>On retrying a connection failure, on the second request the server will see the ID for the
first time, and process it normally.</p></li>

<li><p>On a failure midway through an operation, the server picks up the work and carries it through.
The exact behavior is heavily dependent on implementation, but if the previous operation was
successfully rolled back by way of an ACID database, it’ll be safe to retry it. Otherwise, state
is recovered and the call is continued.</p></li>

<li><p>On a response failure (i.e. the operation executed successfully, but the client couldn’t get
the result), the server simply replies with a cached result of the successful operation.</p></li>
</ul>

<p>In light-4j, we have a component traceability that is a middleware handler to move traceabilityId
from request header to response header. Also, the client module which is used to call services
has the ability to propagate traceabilityId to the next request in the service call stack. This
header can be used as idempotency key on mutating services(i.e. anything under POST in our case).</p>

<p>If the above one request fails due to a network connection error, you can safely retry it
with the same idempotency key, and the services must be designed to work with the idempotency key
/traceabilityId to decide what the business logic with the key.</p>

<h1 id="being-a-good-distributed-citizen">Being a good distributed citizen</h1>

<p>Safely handling failure is hugely important, but beyond that, it’s also recommended that it be
handled in a considerate way. When a client sees that a network operation has failed, there’s
a good chance that it’s due to an intermittent failure that will be gone by the next retry.
However, there’s also a chance that it’s a more serious problem that’s going to be more tenacious;
for example, if the server is in the middle of an incident that’s causing hard downtime. Not only
will retries of the operation not go through, but they may contribute to further degradation.</p>

<p>It’s usually recommended that clients follow something akin to an exponential backoff algorithm
as they see errors. The client blocks for a brief initial wait time on the first failure, but
as the operation continues to fail, it waits proportionally to 2n, where n is the number of
failures that have occurred. By backing off exponentially, we can ensure that clients aren’t
hammering on a downed server and contributing to the problem.</p>

<p>Exponential backoff has a long and interesting history in computer networking.</p>

<p>Furthermore, it’s also a good idea to mix in an element of randomness. If a problem with a
server causes a large number of clients to fail at close to the same time, then even with
back off, their retry schedules could be aligned closely enough that the retries will hammer
the troubled server. This is known as the thundering herd problem.</p>

<p>We can address thundering herd by adding some amount of random “jitter” to each client’s wait
time. This will space out requests across all clients, and give the server some breathing room
to recover.</p>

<p>The client module in <a href="https://github.com/networknt/light-4j">light-4j</a> will be enhanced to retry
on failure automatically with an idempotency key using increasing backoff times and jitter. Given
not all client need to retry on failure, we need to make sure it is configurable in client.yml so
that retry can only be initiated from the original client.</p>

<h1 id="design-robust-apis">Design robust APIs</h1>

<p>Considering the possibility of failure in a distributed system and how to handle it is of
paramount importance in building APIs that are both robust and predictable. Retry logic on
clients and idempotency on servers are techniques that are useful in achieving this goal and
relatively simple to implement in any technology stack.</p>

<p>Here are a few core principles to follow while designing your clients and APIs:</p>

<ul>
<li><p>Make sure that failures are handled consistently. Have clients retry operations against
remote services. Not doing so could leave data in an inconsistent state that will lead to
problems down the road.</p></li>

<li><p>Make sure that failures are handled safely. Use idempotency and idempotency keys to allow
clients to pass a unique value and retry requests as needed.</p></li>

<li><p>Make sure that failures are handled responsibly. Use techniques like exponential backoff
and random jitter. Be considerate of servers that may be stuck in a degraded state.</p></li>
</ul>


			<aside class="copyright" role="note">
				
				&copy; 2017 Released under the MIT license &ndash;
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="https://networknt.github.io/light-4j/design/evolution/" title="Service Evolution">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              Service Evolution
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="https://networknt.github.io/light-4j/design/aggregate/" title="Aggregate">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              Aggregate
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = 'https:\/\/networknt.github.io\/light-4j\/';
      var repo_id  = 'networknt\/light-4j';
    
    </script>

    <script src="https://networknt.github.io/light-4j/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "#";
            headers[i].appendChild(a);
        }
      }
    </script>

    

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

